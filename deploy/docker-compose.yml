services:
  lehrerlog-server:
    container_name: lehrerlog-${ENV_NAME:-prod}-server
    image: ${IMAGE_NAME}:${IMAGE_TAG}
    restart: unless-stopped
    environment:
      - SCHOOL_CATALOG_PATH=/app/data/schools.json
      - SCHOOL_CATALOG_ENDPOINT=${SCHOOL_CATALOG_ENDPOINT:-https://overpass-api.de/api/interpreter}
      - OBJECT_STORAGE_HEALTH_URL=${OBJECT_STORAGE_HEALTH_URL:-}
      - OBJECT_STORAGE_HEALTH_TOKEN=${OBJECT_STORAGE_HEALTH_TOKEN:-}
      - OBJECT_STORAGE_ENDPOINT=${OBJECT_STORAGE_ENDPOINT:-}
      - OBJECT_STORAGE_REGION=${OBJECT_STORAGE_REGION:-garage}
      - OBJECT_STORAGE_ACCESS_KEY=${OBJECT_STORAGE_ACCESS_KEY:-}
      - OBJECT_STORAGE_SECRET_KEY=${OBJECT_STORAGE_SECRET_KEY:-}
      - OBJECT_STORAGE_BUCKET=${OBJECT_STORAGE_BUCKET:-}
      - OBJECT_STORAGE_PATH_STYLE=${OBJECT_STORAGE_PATH_STYLE:-true}
      - SEED_TEST_USER_EMAIL=${SEED_TEST_USER_EMAIL:-}
      - SEED_TEST_USER_PASSWORD_B64=${SEED_TEST_USER_PASSWORD_B64:-}
      - SEED_TEST_USER_FIRST_NAME=${SEED_TEST_USER_FIRST_NAME:-QA}
      - SEED_TEST_USER_LAST_NAME=${SEED_TEST_USER_LAST_NAME:-Verifier}
      - SEED_TEST_SCHOOL_CODE=${SEED_TEST_SCHOOL_CODE:-QA-TEST}
      - SEED_TEST_SCHOOL_NAME=${SEED_TEST_SCHOOL_NAME:-QA Test School}
      - DB_MODE=postgres
      - DATABASE_URL=jdbc:postgresql://db:5432/${POSTGRES_DB:-lehrerlog}
      - DATABASE_USER=${POSTGRES_USER:-lehrerlog}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:?Database password required}
    volumes:
      - ${DATA_DIR:-./data}:/app/data
    ports:
      - "127.0.0.1:${HOST_PORT:-8080}:8080"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - lehrerlog-net

  lehrerlog-webapp:
    container_name: lehrerlog-${ENV_NAME:-prod}-webapp
    image: ${WEBAPP_IMAGE_NAME:-ghcr.io/your-username/lehrerlog-webapp}:${WEBAPP_IMAGE_TAG:-latest}
    restart: unless-stopped
    ports:
      - "127.0.0.1:${WEBAPP_HOST_PORT:-8082}:80"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - lehrerlog-net

  db:
    container_name: lehrerlog-${ENV_NAME:-prod}-db
    image: ${POSTGRES_IMAGE:-postgres:16-alpine}
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-lehrerlog}
      - POSTGRES_USER=${POSTGRES_USER:-lehrerlog}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?Database password required}
    volumes:
      - ${DB_DATA_DIR:-./pgdata}:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-lehrerlog} -d ${POSTGRES_DB:-lehrerlog}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - lehrerlog-net
    # Database is not exposed to host - only accessible within docker network

  garage:
    container_name: lehrerlog-${ENV_NAME:-prod}-garage
    image: ${GARAGE_IMAGE:-dxflrs/garage:v2.2.0}
    restart: unless-stopped
    environment:
      - GARAGE_CONFIG_FILE=/etc/garage.toml
    volumes:
      - ${GARAGE_DIR:-./garage}/data:/data
      - ${GARAGE_DIR:-./garage}/meta:/meta
      - ${GARAGE_CONFIG_PATH:-./garage.toml}:/etc/garage.toml:ro
    ports:
      - "127.0.0.1:${GARAGE_API_PORT:-3900}:3900"
      - "127.0.0.1:${GARAGE_ADMIN_PORT:-3903}:3903"
    healthcheck:
      test: ["CMD-SHELL", "GARAGE_CONFIG_FILE=/etc/garage.toml /garage status >/dev/null 2>&1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - lehrerlog-net

networks:
  lehrerlog-net:
    name: lehrerlog-${ENV_NAME:-prod}-net
    driver: bridge
